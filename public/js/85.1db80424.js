"use strict";(globalThis["webpackChunkmomentum_fw_dev"]=globalThis["webpackChunkmomentum_fw_dev"]||[]).push([[85],{6085:(e,t,s)=>{s.r(t),s.d(t,{default:()=>S});var o=s(1758);function i(e,t,s,i,n,a){const r=(0,o.g2)("router-view"),c=(0,o.g2)("q-page-container"),l=(0,o.g2)("q-layout");return(0,o.uX)(),(0,o.Wv)(l,{view:"hhh LpR fff"},{default:(0,o.k6)((()=>[(0,o.bF)(c,{class:"flex justify-center"},{default:(0,o.k6)((()=>[(0,o.bF)(r,{flipper:e.flipper,serialSupported:e.flags.serialSupported,rpcActive:e.flags.rpcActive,rpcToggling:e.flags.rpcToggling,connected:e.flags.connected,info:e.info,onSelectPort:e.selectPort,onSetRpcStatus:e.setRpcStatus,onSetInfo:e.setInfo,onUpdate:e.onUpdateStage,onShowNotif:e.showNotif,onLog:e.log},null,8,["flipper","serialSupported","rpcActive","rpcToggling","connected","info","onSelectPort","onSetRpcStatus","onSetInfo","onUpdate","onShowNotif","onLog"])])),_:1})])),_:1})}s(4748);var n=s(8734),a=s(4907),r=s(9563),c=s(2314),l=s(2458),g=s.n(l);let h;const p=(0,o.pM)({name:"PacksLayout",setup(){const e=(0,a.A)();return{flipper:(0,n.KR)(r),info:(0,n.KR)(null),flags:(0,n.KR)({serialSupported:!1,portSelectRequired:!1,connected:!1,rpcActive:!1,updateInProgress:!1,settingsView:!1}),reconnectLoop:(0,n.KR)(null),connectionStatus:(0,n.KR)("Ready to connect"),logger:g(),notify:e.notify}},methods:{async connect(){await this.flipper.connect().then((()=>{this.flags.portSelectRequired=!1,this.connectionStatus="Flipper connected",this.flags.connected=!0,this.log({level:"info",message:"Main: Flipper connected"}),h&&h()})).catch((e=>{"Error: No known ports"===e.toString()?this.flags.portSelectRequired=!0:this.connectionStatus=e.toString()}))},async selectPort(){const e=[{usbVendorId:1155,usbProductId:22336}];return await navigator.serial.requestPort({filters:e}),this.start(!0)},async disconnect(){await this.flipper.disconnect().then((()=>{this.connectionStatus="Disconnected",this.flags.connected=!1,this.info=null,this.textInfo=""})).catch((async e=>{if(e.toString().includes("Cannot cancel a locked stream"))return this.flags.rpcActive?await this.stopRpc():(this.flipper.closeReader(),await(0,c.A)(300)),this.disconnect();this.connectionStatus=e.toString()})),this.log({level:"info",message:"Main: Flipper disconnected"})},async startRpc(){this.flags.rpcToggling=!0;const e=await this.flipper.commands.startRpcSession(this.flipper);if(!e.resolved||e.error)throw new Error("Couldn't start rpc session");this.flags.rpcActive=!0,this.flags.rpcToggling=!1,this.log({level:"info",message:"Main: RPC started"})},async stopRpc(){this.flags.rpcToggling=!0,await this.flipper.commands.stopRpcSession(),this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.log({level:"info",message:"Main: RPC stopped"})},async readInfo(){this.info={};let e=await this.flipper.commands.system.deviceInfo().catch((e=>this.rpcErrorHandler(e,"system.deviceInfo"))).finally((()=>{this.$emit("log",{level:"debug",message:"Main: system.deviceInfo: OK"})}));for(const t of e)this.info[t.key]=t.value;e=await this.flipper.commands.system.powerInfo().catch((e=>this.rpcErrorHandler(e,"system.powerInfo"))).finally((()=>{this.$emit("log",{level:"debug",message:"Main: system.powerInfo: OK"})}));for(const t of e)this.info[t.key]=t.value;if(await(0,c.A)(300),e=await this.flipper.commands.storage.list("/ext").catch((e=>this.rpcErrorHandler(e,"storage.list"))).finally((()=>{this.$emit("log",{level:"debug",message:"Main: storage.list: /ext"})})),e&&"object"===typeof e&&e.length){const t=e.find((e=>"Manifest"===e.name));this.info.storage_databases_present=t?"installed":"missing",e=await this.flipper.commands.storage.info("/ext").catch((e=>this.rpcErrorHandler(e,"storage.info"))).finally((()=>{this.$emit("log",{level:"debug",message:"Main: storage.info: /ext"})})),this.info.storage_sdcard_present="installed",this.info.storage_sdcard_totalSpace=e.totalSpace,this.info.storage_sdcard_freeSpace=e.freeSpace}else this.info.storage_sdcard_present="missing",this.info.storage_databases_present="missing";await(0,c.A)(200),e=await this.flipper.commands.storage.info("/int").catch((e=>this.rpcErrorHandler(e,"storage.info"))).finally((()=>{this.$emit("log",{level:"debug",message:"Main: storage.info: /int"})})),this.info.storage_internal_totalSpace=e.totalSpace,this.info.storage_internal_freeSpace=e.freeSpace,this.log({level:"info",message:"Main: Fetched device info"}),this.info={...this.info}},findKnownDevices(){const e=[{usbVendorId:1155,usbProductId:22336}];return navigator.serial.getPorts({filters:e})},autoReconnect(){this.reconnectLoop&&(clearInterval(this.reconnectLoop),this.reconnectLoop=null),this.reconnectLoop=setInterval((async()=>{const e=await this.findKnownDevices();if(e&&e.length>0)return clearInterval(this.reconnectLoop),this.reconnectLoop=null,await this.start()}),3e3)},setRpcStatus(e){this.flags.rpcActive=e},setInfo(e){this.info=e},onUpdateStage(e){"start"===e?this.flags.updateInProgress=!0:"end"===e&&(this.flags.updateInProgress=!1)},showNotif({message:e,color:t,reloadBtn:s}){const o=[];s&&o.push({label:"Reload",color:"white",handler:()=>{location.reload()}}),0===o.length?o.push({icon:"close",color:"white",class:"q-px-sm"}):o.push({label:"Dismiss",color:"white"}),h=this.notify({message:e,color:t,textColor:"white",position:"bottom-right",timeout:0,group:!0,actions:o})},log({level:e,message:t}){switch(e){case"error":this.logger.error(t);break;case"warn":this.logger.warn(t);break;case"info":this.logger.info(t);break;case"debug":this.logger.debug(t);break}},rpcErrorHandler(e,t){e=e.toString(),this.showNotif({message:`RPC error in command '${t}': ${e}`,color:"negative"}),this.log({level:"error",message:`Main: RPC error in command '${t}': ${e}`})},async start(e){const t=await this.findKnownDevices();if(t&&t.length>0)await this.connect(),await this.startRpc(),await this.readInfo();else if(this.flags.portSelectRequired=!0,e)return this.selectPort()}},async mounted(){"serial"in navigator&&(this.flags.serialSupported=!0,await this.start(),navigator.serial.addEventListener("disconnect",(e=>{this.autoReconnect()})),navigator.serial.addEventListener("disconnect",(e=>{this.flags.updateInProgress||(this.showNotif({message:"Flipper has been disconnected"}),this.flags.connected=!1,this.flags.portSelectRequired=!0),this.log({level:"info",message:"Main: Flipper has been disconnected"})}))),this.logger.setLevel("debug",!0);const e=this.logger.methodFactory;this.logger.methodFactory=function(t,s,o){const i=e(t,s,o);return function(e){"debug"!==t&&i(e)}}}});var f=s(2807),d=s(557),u=s(5205),m=s(8582),v=s.n(m);const w=(0,f.A)(p,[["render",i]]),S=w;v()(p,"components",{QLayout:d.A,QPageContainer:u.A})}}]);