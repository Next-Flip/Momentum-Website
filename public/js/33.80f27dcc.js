"use strict";(globalThis["webpackChunkmomentum_fw_dev"]=globalThis["webpackChunkmomentum_fw_dev"]||[]).push([[33],{1033:(t,e,s)=>{s.r(e),s.d(e,{default:()=>_});var a=s(1758),i=s(8790);const r={class:"flex-center column align-items-center"},l=(0,a.Lk)("p",null,"Loading Asset Packs...",-1),n=["src"],o={class:"text-h5 text-bold text-center"},c={class:"text-h7 text-center"};function g(t,e,s,g,p,h){const d=(0,a.g2)("q-spinner"),m=(0,a.g2)("q-btn"),f=(0,a.g2)("q-card-actions"),u=(0,a.g2)("q-card"),k=(0,a.g2)("q-list"),v=(0,a.g2)("q-page");return(0,a.uX)(),(0,a.Wv)(v,{class:"flex-center column full-width"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",r,[null===t.packs?((0,a.uX)(),(0,a.CE)(a.FK,{key:0},[(0,a.bF)(d,{color:"primary",size:"3em",class:"q-mb-md"}),l],64)):((0,a.uX)(),(0,a.Wv)(k,{key:1,class:"packs-grid"},{default:(0,a.k6)((()=>[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(t.packs,(e=>((0,a.uX)(),(0,a.Wv)(u,(0,a.v6)({key:e.name},e,{class:"my-card",dark:""}),{default:(0,a.k6)((()=>[(0,a.Lk)("img",{src:e.image},null,8,n),(0,a.Lk)("div",o,(0,i.v_)(e.name),1),(0,a.Lk)("div",c,"By "+(0,i.v_)(e.author),1),(0,a.bF)(f,{align:"stretch"},{default:(0,a.k6)((()=>[(0,a.bF)(m,{href:e.download,class:"main-btn",style:{flex:"1"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Download")])),_:2},1032,["href"]),e.name!==t.installing?((0,a.uX)(),(0,a.Wv)(m,{key:0,disable:!t.serialSupported||null!==t.installing||t.rpcToggling,onClick:s=>t.install(e),class:"main-btn",style:{flex:"1"},flat:""},{default:(0,a.k6)((()=>[(0,a.eW)((0,i.v_)(t.serialSupported?t.rpcToggling?"Connecting":t.connected?"Install":"Connect":"Unsupported"),1)])),_:2},1032,["disable","onClick"])):((0,a.uX)(),(0,a.Wv)(m,{key:1,class:"main-btn",style:(0,i.Tr)(`flex: 1; background-image: linear-gradient(to right, #a883e9 ${100*t.progress}%, transparent ${100*t.progress}%);`),disable:"",flat:""},{default:(0,a.k6)((()=>[(0,a.eW)("Installing")])),_:1},8,["style"]))])),_:2},1024)])),_:2},1040)))),128))])),_:1}))])])),_:1})}var p=s(7360),h=s(8734),d=s(2314);const m=(0,a.pM)({name:"PagePacks",props:{flipper:Object,connected:Boolean,rpcActive:Boolean,rpcToggling:Boolean,serialSupported:Boolean,info:Object},setup(){return{packs:(0,h.KR)(null),flags:(0,h.KR)({restarting:!1,rpcActive:!1,rpcToggling:!1}),progress:(0,h.KR)(0),installing:(0,h.KR)(null)}},watch:{async info(t,e){null!==t&&t.storage_databases_present&&this.connected&&await this.start()}},methods:{async install(t){if(this.serialSupported)if(this.connected&&null!=this.info&&this.rpcActive)try{this.installing=t.name,this.progress=0;const e=await(0,p.q3)(t.download).catch((t=>{throw this.$emit("showNotif",{message:"Failed to fetch pack: "+t.toString(),color:"negative"}),this.$emit("log",{level:"error",message:"Packs: Failed to fetch pack: "+t.toString()}),t})).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: Downloaded pack from "+t.download})})),s=Object.entries(e).sort(((t,e)=>t[0]>e[0]?1:-1));let a="/ext",i="asset_packs/"+s[0][0];i.endsWith("/")&&(i=i.slice(0,-1));for(const t of i.split("/"))a+="/"+t,await this.flipper.commands.storage.mkdir(a).catch((t=>this.rpcErrorHandler(t,"storage.mkdir"))).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: storage.mkdir: "+a})}));let r=0;for(const[t,l]of s)0===l.byteLength?(a="/ext/asset_packs/"+t,t.endsWith("/")&&(a=a.slice(0,-1)),await this.flipper.commands.storage.mkdir(a).catch((t=>this.rpcErrorHandler(t,"storage.mkdir"))).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: storage.mkdir: "+a})}))):await this.flipper.commands.storage.write("/ext/asset_packs/"+t,l.buffer).catch((t=>this.rpcErrorHandler(t,"storage.write"))).finally((()=>{this.$emit("log",{level:"debug",message:"Packs: storage.write: /ext/asset_packs/"+t})})),r++,this.progress=r/s.length}finally{this.installing=null,this.progress=0}else this.rpcToggling||this.$emit("selectPort")},async startRpc(){this.flags.rpcToggling=!0;const t=await this.flipper.commands.startRpcSession(this.flipper);if(!t.resolved||t.error)throw this.$emit("showNotif",{message:"Unable to start RPC session. Reload the page or reconnect Flipper manually.",color:"negative",reloadBtn:!0}),this.$emit("log",{level:"error",message:"Device: Couldn't start rpc session"}),new Error("Couldn't start rpc session");this.flags.rpcActive=!0,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!0),this.$emit("log",{level:"info",message:"Device: RPC started"})},async stopRpc(){this.flags.rpcToggling=!0,await this.flipper.commands.stopRpcSession(),this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!1),this.$emit("log",{level:"info",message:"Device: RPC stopped"})},async restartRpc(t){(this.connected&&this.flags.rpcActive&&!this.flags.restarting||t)&&(this.flags.restarting=!0,await this.flipper.closeReader(),await(0,d.A)(300),await this.flipper.disconnect(),await(0,d.A)(300),await this.flipper.connect(),await this.startRpc(),this.$emit("log",{level:"info",message:"Device: Restarted RPC"}))},passNotif(t){this.$emit("showNotif",t)},passLog(t){this.$emit("log",t)},rpcErrorHandler(t,e){t=t.toString(),this.$emit("showNotif",{message:`RPC error in command '${e}': ${t}`,color:"negative"}),this.$emit("log",{level:"error",message:`Device: RPC error in command '${e}': ${t}`})},async start(){this.serialSupported&&(this.flags.rpcActive=this.rpcActive,this.rpcActive||(setTimeout((()=>{if(!this.rpcActive)return this.restartRpc(!0)}),1e3),await this.startRpc()),navigator.serial.addEventListener("disconnect",(t=>{this.flags.rpcActive=!1,this.flags.rpcToggling=!1,this.$emit("setRpcStatus",!1)})))}},async mounted(){this.packs=await(0,p.vy)().catch((t=>{throw this.$emit("showNotif",{message:"Unable to load asset packs from the server. Reload the page and try again.",color:"negative",reloadBtn:!0}),this.$emit("log",{level:"error",message:"Packs: Failed to fetch pack list"}),t})),this.connected&&null!==this.info&&this.info.storage_databases_present&&await this.start()},async beforeUnmount(){this.unbindRestart(),await(0,d.A)(3e3)}});var f=s(2807),u=s(7716),k=s(564),v=s(3999),w=s(3316),b=s(2669),y=s(1693),$=s(8582),R=s.n($);const A=(0,f.A)(m,[["render",g]]),_=A;R()(m,"components",{QPage:u.A,QSpinner:k.A,QList:v.A,QCard:w.A,QCardActions:b.A,QBtn:y.A})}}]);